<div id="analytics_line" style="min-width: 310px; height: 400px; margin: 0 auto"></div>

<form action="">
  <p><strong>Add/Remove past deals data into Analytics of Deals chart!</strong></p>

  <div class="container">
    <% num_of_expired_deals = @deals_daily_count[2].size %>
    <% loops = 0 %>
    <% while loops < num_of_expired_deals %>
        <input id="expired_deal<%= loops %>" type="checkbox" value="<%= @deals_daily_count[2][loops] %>"><%= @deals_daily_count[2][loops] %>
        <br/>
        <% loops = loops + 1 %>
    <% end %>
  </div>
</form>

<footer>
  <script src="http://code.highcharts.com/stock/highstock.js"></script>
  <script src="http://code.highcharts.com/stock/modules/exporting.js"></script>
  <script src="https://code.highcharts.com/modules/drilldown.js"></script>

  <style type="text/css">
      .container {
          border: 2px solid #ccc;
          width: 500px;
          height: 100px;
          overflow-y: scroll;
          float: left;
      }
  </style>

  <script>
      $(function () {
          Highcharts.setOptions({
              global: {
                  useUTC: false
              }
          });
          $('#analytics_line').highcharts('StockChart', {
              credits: {
                  enabled: false
              },
              title: {
                  text: 'Analytics of Deals'
              },
              subtitle: {
                  text: 'View Count and Redemption Count'
              },
              rangeSelector: {
                  allButtonsEnabled: true,
                  buttons: [{
                      type: 'month',
                      count: 3,
                      text: 'Day',
                      dataGrouping: {
                          forced: true,
                          units: [['day', [1]]]
                      }
                  }, {
                      type: 'year',
                      count: 1,
                      text: 'Week',
                      dataGrouping: {
                          forced: true,
                          units: [['week', [1]]]
                      }
                  }],
                  buttonTheme: {
                      width: 60
                  },
              },

              yAxis: {
                  floor: 0,
                  title: {
                      text: 'Number'
                  }
              },

              plotOptions: {
                  dataLabels: {
                      visible: true
                  },
              },

              tooltip: {
                  pointFormat: '<span style="color:{series.color}">{series.name}</span>: <b>{point.y}</b><br/>'
              },
              legend: {
                  enabled: true,
                  align: 'right',
                  backgroundColor: '#FCFFC5',
                  borderColor: 'black',
                  borderWidth: 2,
                  layout: 'vertical',
                  verticalAlign: 'top',
                  y: 100,
                  shadow: true
              },

              series: [
                  <% num_active_deals = @deals_daily_count[0].size %>
                  <% num = 0 %>
                  <% visibility = true %>
                  <% while num < num_active_deals %>
                  {
                      id: "<%= @deals_daily_count[0][num][0] %>" + ' (View Count)',
                      name: "<%= @deals_daily_count[0][num][0] %>" + " (View Count)",
                      pointStart: <%= @deals_daily_count[0][num][1] %>,
                      pointInterval: 24 * 3600 * 1000,
                      data: <%= @deals_daily_count[0][num][2] %>,
                      visible: <%= visibility %>
                  }, {
                      id: "<%= @deals_daily_count[0][num][0] %>" + ' (Redemption Count)',
                      name: "<%= @deals_daily_count[0][num][0] %>" + ' (Redemption Count)',
                      pointStart: <%= @deals_daily_count[0][num][1] %>,
                      pointInterval: 24 * 3600 * 1000,
                      data: <%= @deals_daily_count[0][num][3] %>,
                      visible: <%= visibility %>
                  },
                  <% num = num + 1 %>
                  <% visibility = false %>
                  <% end %>
              ]
          }, function (chart) {

              // apply the date pickers
              setTimeout(function () {
                  $('input.highcharts-range-selector', $(chart.container).parent())
                          .datepicker();
              }, 0);
          });

          // Set the datepicker's date format
          $.datepicker.setDefaults({
              dateFormat: 'yy-mm-dd',
              onSelect: function () {
                  this.onchange();
                  this.onblur();
              }
          });

          <% loops = 0 %>
          <% while loops < num_of_expired_deals %>
          $('#expired_deal' + '<%=loops%>').click(function () {
              var chart = $('#analytics_line').highcharts();
              if ($(this).is(':checked')) {
                  chart.addSeries({
                      id: "<%= @deals_daily_count[1][loops][0] %>" + ' (View Count)',
                      name: "<%= @deals_daily_count[1][loops][0] %>" + ' (View Count)',
                      pointStart: <%= @deals_daily_count[1][loops][1] %>,
                      pointInterval: 24 * 3600 * 1000,
                      data: <%= @deals_daily_count[1][loops][2] %>
                  });
                  chart.addSeries({
                      id: "<%= @deals_daily_count[1][loops][0] %>" + ' (Redemption Count)',
                      name: "<%= @deals_daily_count[1][loops][0] %>" + ' (Redemption Count)',
                      pointStart: <%= @deals_daily_count[1][loops][1] %>,
                      pointInterval: 24 * 3600 * 1000,
                      data: <%= @deals_daily_count[1][loops][3] %>
                  });
              }
              else {
                  var view_series = chart.get("<%= @deals_daily_count[1][loops][0] %>" + ' (View Count)')
                  var redeem_series = chart.get("<%= @deals_daily_count[1][loops][0] %>" + ' (Redemption Count)')
                  view_series.remove();
                  redeem_series.remove();
              }

          });
          <% loops = loops + 1 %>
          <% end %>
      });

  </script>
</footer>